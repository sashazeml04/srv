<!DOCTYPE HTML>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SRV</title>
<style>
:root {
  --primary: #2563eb;
  --secondary: #4b5563;
  --success: #16a34a;
  --danger: #dc2626;
  --light: #f9fafb;
  --dark: #1f2937;
  --border: 1px solid #e5e7eb;
}

body {
  font-family: 'Inter', system-ui, -apple-system, sans-serif;
  margin: 0;
  padding: 2rem;
  background: #f3f4f6;
  color: var(--dark);
  line-height: 1.5;
  -webkit-font-smoothing: antialiased;
}

.container {
  max-width: 800px;
  margin: 0 auto;
  background: white;
  padding: 2.5rem;
  border-radius: 16px;
  box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
}

h1 {
  color: var(--dark);
  margin: 0 0 2rem 0;
  font-size: 2rem;
  font-weight: 700;
  letter-spacing: -0.025em;
  position: relative;
  padding-bottom: 1rem;
}

h1::after {
  content: '';
  position: absolute;
  bottom: 0;
  left: 0;
  width: 3rem;
  height: 3px;
  background: var(--primary);
  border-radius: 2px;
}

.time-section {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
  gap: 1.5rem;
  margin-bottom: 2.5rem;
}

.time-card {
  background: var(--light);
  padding: 1.5rem;
  border-radius: 12px;
  border: var(--border);
  transition: transform 0.2s ease;
}

.time-card:hover {
  transform: translateY(-2px);
}

.time-card h2 {
  margin: 0 0 0.75rem 0;
  font-size: 0.875rem;
  font-weight: 500;
  color: var(--secondary);
  text-transform: uppercase;
  letter-spacing: 0.05em;
}

.time-value {
  font-size: 1.25rem;
  font-weight: 600;
  color: var(--primary);
  font-feature-settings: 'tnum' 1;
}

.time-value.internet-ok {
  color: var(--success);
}

.time-value.internet-off {
  color: var(--danger);
}

.upload-section {
  margin-top: 1.8rem;
  border-top: 1px solid #eee;
  padding-top: 2rem;
}

.relay-control {
  margin: 2rem 0;
  padding: 2rem;
  background: var(--light);
  border-radius: 12px;
  border: var(--border);
}

.relay-buttons {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 1.5rem;
  margin-top: 1.5rem;
}

#relayBtn_1, #relayBtn_2, #relayBtn_3, #relayBtn_4 {
  padding: 1rem 2rem;
  font-size: 1.2rem;
  min-width: 120px;
  transition: all 0.3s ease;
}

#relayBtn_1.active, #relayBtn_2.active, 
#relayBtn_3.active, #relayBtn_4.active {
  background: var(--success);
  border-color: var(--success);
}

.relay-status {
  font-weight: 500;
  color: var(--dark);
}

form {
  margin: 2rem 0;
  background: var(--light);
  padding: 2rem;
  border-radius: 12px;
  border: var(--border);
}

input[type="file"] {
  width: 100%;
  margin: 1rem 0;
  padding: 0.75rem;
  border: 2px dashed #cbd5e1;
  border-radius: 8px;
  background: white;
  transition: border-color 0.2s ease;
}

input[type="file"]:hover {
  border-color: var(--primary);
}

button {
  padding: 0.875rem 1.75rem;
  border-radius: 8px;
  font-weight: 600;
  transition: all 0.2s ease;
  cursor: pointer;
  display: inline-flex;
  align-items: center;
  gap: 0.5rem;
}

.btn-primary {
  background: var(--primary);
  color: white;
  border: 2px solid var(--primary);
}

.btn-primary:hover {
  background: #1d4ed8;
  transform: translateY(-1px);
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

.btn-secondary {
  background: var(--secondary);
  color: white;
}

.loading {
  display: none;
  padding: 1rem;
  background: var(--primary);
  color: white;
  border-radius: 4px;
  margin: 1rem 0;
  text-align: center;
}

#message {
  margin: 1rem 0;
  padding: 1rem;
  border-radius: 4px;
  display: none;
}

.success {
  background: #d4edda;
  color: #155724;
  display: block;
}

.error {
  background: #f8d7da;
  color: #721c24;
  display: block;
}

.firmware-section {
  margin-top: 2rem;
  padding: 1.5rem;
  background: #fff3cd;
  border-radius: 8px;
  border: 1px solid #ffeeba;
}

/* Стиль для кнопки автоматического режима */
.automat-btn {
  margin: 20px 0;
  padding: 15px 25px;
  font-size: 1.2rem;
  min-width: 200px;
  background-color: var(--primary); /* Синий по умолчанию */
  color: white;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  transition: all 0.3s ease;
  font-weight: 600;
}

.automat-btn.active {
  background-color: var(--success); /* Зеленый при активном режиме */
}

.automat-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

/* Стиль для заблокированной кнопки */
.btn-disabled {
  background-color: #cccccc !important;
  cursor: not-allowed !important;
  opacity: 0.6;
}

@media (max-width: 640px) {
  .container {
    padding: 1.5rem;
  }
  
  h1 {
    font-size: 1.75rem;
  } 
  
  .time-section {
    grid-template-columns: 1fr;
  }
}
</style>
<script>
function updateTime() {
  var xhr = new XMLHttpRequest();
  xhr.onreadystatechange = function() {
    if (this.readyState == 4 && this.status == 200) {
      document.getElementById("time").innerHTML = this.responseText;
    }
  };
  xhr.open("GET", "/time", true);
  xhr.send();
}

function updateDate() {
  var xhr = new XMLHttpRequest();
  xhr.onreadystatechange = function() {
    if (this.readyState == 4 && this.status == 200) {
      document.getElementById("date").innerHTML = this.responseText;
    }
  };
  xhr.open("GET", "/date", true);
  xhr.send();
}

function upinitialTime() {
  var xhr = new XMLHttpRequest();
  xhr.onreadystatechange = function() {
    if (this.readyState == 4 && this.status == 200) {
      document.getElementById("initialTime").innerHTML = this.responseText;
    }
  };
  xhr.open("GET", "/initialTime", true);
  xhr.send();
}

function upinitialDate() {
  var xhr = new XMLHttpRequest();
  xhr.onreadystatechange = function() {
    if (this.readyState == 4 && this.status == 200) {
      document.getElementById("initialDate").innerHTML = this.responseText;
    }
  };
  xhr.open("GET", "/initialDate", true);
  xhr.send();
}

function up_current_mA() {
  var xhr = new XMLHttpRequest();
  xhr.onreadystatechange = function() {
    if (this.readyState == 4 && this.status == 200) {
      document.getElementById("current_mA").innerHTML = this.responseText;
    }
  };
  xhr.open("GET", "/current_mA", true);
  xhr.send();
}

function up_power_mW() {
  var xhr = new XMLHttpRequest();
  xhr.onreadystatechange = function() {
    if (this.readyState == 4 && this.status == 200) {
      document.getElementById("power_mW").innerHTML = this.responseText;
    }
  };
  xhr.open("GET", "/power_mW", true);
  xhr.send();
}

function up_loadvoltage() {
  var xhr = new XMLHttpRequest();
  xhr.onreadystatechange = function() {
    if (this.readyState == 4 && this.status == 200) {
      document.getElementById("loadvoltage").innerHTML = this.responseText;
    }
  };
  xhr.open("GET", "/loadvoltage", true);
  xhr.send();
}

function up_rele1() {
  var xhr = new XMLHttpRequest();
  xhr.onreadystatechange = function() {
    if (this.readyState == 4 && this.status == 200) {
      document.getElementById("rele1").innerHTML = this.responseText;
    }
  };
  xhr.open("GET", "/rele1", true);
  xhr.send();
}

function up_rele2() {
  var xhr = new XMLHttpRequest();
  xhr.onreadystatechange = function() {
    if (this.readyState == 4 && this.status == 200) {
      document.getElementById("rele2").innerHTML = this.responseText;
    }
  };
  xhr.open("GET", "/rele2", true);
  xhr.send();
}

function up_rele3() {
  var xhr = new XMLHttpRequest();
  xhr.onreadystatechange = function() {
    if (this.readyState == 4 && this.status == 200) {
      document.getElementById("rele3").innerHTML = this.responseText;
    }
  };
  xhr.open("GET", "/rele3", true);
  xhr.send();
}

function up_rele4() {
  var xhr = new XMLHttpRequest();
  xhr.onreadystatechange = function() {
    if (this.readyState == 4 && this.status == 200) {
      document.getElementById("rele4").innerHTML = this.responseText;
    }
  };
  xhr.open("GET", "/rele4", true);
  xhr.send();
}

function up_tempC() {
  var xhr = new XMLHttpRequest();
  xhr.onreadystatechange = function() {
    if (this.readyState == 4 && this.status == 200) {
      document.getElementById("tempC").innerHTML = this.responseText;
    }
  };
  xhr.open("GET", "/tempC", true);
  xhr.send();
}

function up_Tflag() {
  var xhr = new XMLHttpRequest();
  xhr.onreadystatechange = function() {
    if (this.readyState == 4 && this.status == 200) {
      document.getElementById("Tflag").innerHTML = this.responseText;
    }
  };
  xhr.open("GET", "/Tflag", true);
  xhr.send();
}

function firmware() {
  var xhr = new XMLHttpRequest();
  xhr.onreadystatechange = function() {
    if (this.readyState == 4 && this.status == 200) {
      document.getElementById("firmware").innerHTML = this.responseText;
    }
  };
  xhr.open("GET", "/firmware", true);
  xhr.send();
}

function checkInternet() {
  var xhr = new XMLHttpRequest();
  xhr.onreadystatechange = function() {
    if (this.readyState == 4 && this.status == 200) {
      var statusElement = document.getElementById("checkInternet");
      var response = this.responseText.trim();
      statusElement.innerHTML = response;
      statusElement.classList.remove("internet-ok", "internet-off");
      
      if (response === "Internet Ok") {
        statusElement.classList.add("internet-ok");
      } else if (response === "Internet Off") {
        statusElement.classList.add("internet-off");
      }
    }
  };
  xhr.open("GET", "/checkInternet", true);
  xhr.send();
}

function uploadFile(file, url, successMessage, errorMessage) {
  var xhr = new XMLHttpRequest();
  var formData = new FormData();
  formData.append("file", file);

  document.getElementById("loading").style.display = "block";

  xhr.open("POST", url, true);
  xhr.onload = function() {
    document.getElementById("loading").style.display = "none";
    if (xhr.status == 200) {
      showMessage(successMessage, "success");
    } else {
      showMessage(errorMessage + " (Ошибка: " + xhr.status + ")", "error");
    }
  };
  xhr.onerror = function() {
    document.getElementById("loading").style.display = "none";
    showMessage("Ошибка сети. Проверьте подключение.", "error");
  };
  xhr.send(formData);
}

function showMessage(message, className) {
  var messageDiv = document.getElementById("message");
  messageDiv.textContent = message;
  messageDiv.className = className;
  setTimeout(function() {
    messageDiv.textContent = "";
    messageDiv.className = "";
  }, 5000);
}

function uploadConfig() {
  var file = document.getElementById("configFile").files[0];
  if (file) {
    if (file.name.endsWith(".json")) {
      uploadFile(file, "/upload", "Файл config.json успешно загружен!", "Ошибка загрузки config.json");
    } else {
      showMessage("Неподходящий формат файла. Требуется .json.", "error");
    }
  } else {
    showMessage("Пожалуйста, выберите файл config.json.", "error");
  }
}

function uploadIndex() {
  var file = document.getElementById("indexFile").files[0];
  if (file) {
    if (file.name.endsWith(".html")) {
      uploadFile(file, "/upload", "Файл index.html успешно загружен!", "Ошибка загрузки index.html");
    } else {
      showMessage("Неподходящий формат файла. Требуется .html.", "error");
    }
  } else {
    showMessage("Пожалуйста, выберите файл index.html.", "error");
  }
}

function updateFirmware() {
  var file = document.getElementById("firmwareFile").files[0];
  if (file) {
    if (file.name.endsWith(".bin")) {
      if (confirm("Вы уверены, что хотите обновить прошивку? Это действие нельзя отменить.")) {
        var xhr = new XMLHttpRequest();
        var formData = new FormData();
        formData.append("file", file);

        document.getElementById("loading").style.display = "block";

        xhr.open("POST", "/update", true);
        xhr.onload = function() {
          document.getElementById("loading").style.display = "none";
          if (xhr.status == 200) {
            alert("Прошивка успешно обновлена! Устройство перезагрузится.");
          } else {
            alert("Ошибка обновления прошивки: " + xhr.statusText);
          }
        };
        xhr.onerror = function() {
          document.getElementById("loading").style.display = "none";
          alert("Ошибка сети. Проверьте подключение.");
        };
        xhr.send(formData);
      }
    } else {
      alert("Неподходящий формат файла. Требуется .bin.");
    }
  } else {
    alert("Пожалуйста, выберите файл прошивки.");
  }
}

function reset_Tflag() {
  const btn = document.getElementById('reset_Tflag');
  btn.disabled = true;
  
  fetch('/reset_Tflag')
    .then(() => up_reset_Tflag())
    .finally(() => btn.disabled = false);
}

function updateRelayState_1() {
  fetch('/status_RELAY1')
    .then(response => response.text())
    .then(state => {
      const btn = document.getElementById('relayBtn_1');
      const statusElement = document.getElementById('RELAY1');
      
      btn.innerHTML = state;
      btn.classList.toggle('active', state === 'ON');
      statusElement.textContent = state;
    });
}

function toggleRelay_1() {
  const btn = document.getElementById('relayBtn_1');
  btn.disabled = true;
  
  fetch('/toggle_RELAY1')
    .then(() => updateRelayState_1())
    .finally(() => btn.disabled = false);
}

function updateRelayState_2() {
  fetch('/status_RELAY2')
    .then(response => response.text())
    .then(state => {
      const btn = document.getElementById('relayBtn_2');
      const statusElement = document.getElementById('RELAY2');
      
      btn.innerHTML = state;
      btn.classList.toggle('active', state === 'ON');
      statusElement.textContent = state;
    });
}

function toggleRelay_2() {
  const btn = document.getElementById('relayBtn_2');
  btn.disabled = true;
  
  fetch('/toggle_RELAY2')
    .then(() => updateRelayState_2())
    .finally(() => btn.disabled = false);
}

function updateRelayState_3() {
  fetch('/status_RELAY3')
    .then(response => response.text())
    .then(state => {
      const btn = document.getElementById('relayBtn_3');
      const statusElement = document.getElementById('RELAY3');
      
      btn.innerHTML = state;
      btn.classList.toggle('active', state === 'ON');
      statusElement.textContent = state;
    });
}

function toggleRelay_3() {
  const btn = document.getElementById('relayBtn_3');
  btn.disabled = true;
  
  fetch('/toggle_RELAY3')
    .then(() => updateRelayState_3())
    .finally(() => btn.disabled = false);
}

function updateRelayState_4() {
  fetch('/status_RELAY4')
    .then(response => response.text())
    .then(state => {
      const btn = document.getElementById('relayBtn_4');
      const statusElement = document.getElementById('RELAY4');
      
      btn.innerHTML = state;
      btn.classList.toggle('active', state === 'ON');
      statusElement.textContent = state;
    });
}

function toggleRelay_4() {
  const btn = document.getElementById('relayBtn_4');
  btn.disabled = true;
  
  fetch('/toggle_RELAY4')
    .then(() => updateRelayState_4())
    .finally(() => btn.disabled = false);
}

// Функция для переключения автоматического режима
function toggleAutomat() {
  const btn = document.getElementById('automatBtn');
  btn.disabled = true;
  
  fetch('/automat_flag')
    .then(response => response.text())
    .then(state => {
      updateAutomatState(); // Обновляем состояние после изменения
      updateRelay3ButtonState(); // Обновляем состояние кнопки RELAY3
      btn.disabled = false;
    })
    .catch(() => {
      btn.disabled = false;
    });
}

// Функция для обновления состояния автоматического режима
function updateAutomatState() {
  fetch('/automat_status')
    .then(response => response.text())
    .then(state => {
      const btn = document.getElementById('automatBtn');
      btn.innerHTML = "AUTO MODE (" + state + ")";
      btn.classList.toggle('active', state === 'ON');
      
      // Обновляем состояние кнопки RELAY3
      updateRelay3ButtonState();
    });
}

// Функция для обновления состояния кнопки RELAY3
function updateRelay3ButtonState() {
  fetch('/automat_status')
    .then(response => response.text())
    .then(state => {
      const relayBtn3 = document.getElementById('relayBtn_3');
      if (relayBtn3) {
        if (state === 'ON') {
          // Включаем автоматический режим - блокируем кнопку
          relayBtn3.disabled = true;
          relayBtn3.classList.add('btn-disabled');
        } else {
          // Выключаем автоматический режим - разблокируем кнопку
          relayBtn3.disabled = false;
          relayBtn3.classList.remove('btn-disabled');
        }
      }
    });
}

document.addEventListener('DOMContentLoaded', function() {
  updateRelayState_1();
  updateRelayState_2();
  updateRelayState_3();
  updateRelayState_4();
  upinitialTime();
  upinitialDate();
  firmware();
  updateAutomatState(); // Инициализация состояния кнопки
  updateRelay3ButtonState(); // Инициализация состояния кнопки RELAY3
});

// Автоматическое обновление
setInterval(firmware, 12000);
setInterval(updateRelayState_1, 1000);
setInterval(updateRelayState_2, 1000);
setInterval(up_rele1, 1000);
setInterval(up_rele2, 1000);
setInterval(updateRelayState_3, 1000);
setInterval(updateRelayState_4, 1000);
setInterval(up_rele3, 1000);
setInterval(up_rele4, 1000);
setInterval(up_Tflag, 1000);
setInterval(up_tempC, 1000);
setInterval(up_loadvoltage, 1000);
setInterval(up_current_mA, 1000);
setInterval(up_power_mW, 1000);
setInterval(checkInternet, 5000);
setInterval(upinitialTime, 10000);
setInterval(upinitialDate, 10000);
setInterval(updateDate, 1000);
setInterval(updateTime, 1000);
setInterval(updateAutomatState, 1000);
setInterval(updateRelay3ButtonState, 1000); // Обновление состояния кнопки RELAY3
</script>
</head>
<body>
  <div class="container">
    <div class="time-section">
      <div class="time-card">
        <h2>Текущее время</h2>
        <div class="time-value" id="time">%TIME%</div>
      </div>
      <div class="time-card">
        <h2>Текущая дата</h2>
        <div class="time-value" id="date">%DATE%</div>
      </div>
      <div class="time-card">
        <h2>Подключился к интернету в:</h2>
        <div class="datetime-wrapper">
          <div class="time-value" id="initialTime">%INITTIME%</div>
          <div class="time-value" id="initialDate">%INITDATE%</div>
        </div>
      </div>
      
      <div class="time-card">
        <h2>Статус интернета</h2>
        <div class="time-value" id="checkInternet">%CHECK%</div>
      </div>
  
      <div class="time-card">
        <h2>current_mA</h2>
        <div class="time-value" id="current_mA">%current_mA%</div>
      </div>
      <div class="time-card">
        <h2>power_mW</h2>
        <div class="time-value" id="power_mW">%power_mW%</div>
      </div>
      <div class="time-card">
        <h2>loadvoltage</h2>
        <div class="time-value" id="loadvoltage">%loadvoltage%</div>
      </div>
      <div class="time-card">
        <h2>Статус rele1</h2>
        <div class="time-value" id="rele1">%rele1%</div>
      </div>
      <div class="time-card">
        <h2>Статус rele2</h2>
        <div class="time-value" id="rele2">%rele2%</div>
      </div>
      
      <div class="time-card">
        <h2>Статус rele3</h2>
        <div class="time-value" id="rele3">%rele3%</div>
      </div>
      
      <div class="time-card">
        <h2>Статус rele4</h2>
        <div class="time-value" id="rele4">%rele4%</div>
      </div>
      
      <div class="time-card">
        <h2>tempC</h2>
        <div class="time-value" id="tempC">%tempC%</div>
      </div>
      <div class="time-card">
        <h2>Количество переподключений Tflag</h2>
        <div class="time-value" id="Tflag">%TFLAG%</div>
       <button id="reset_Tflag" class="btn-primary" onclick="reset_Tflag()"> reset_Tflag
      </button>
      </div>
      <div class="time-card">
        <h2>Прошивка</h2>
        <div class="time-value" id="firmware">%firmware%</div>
      </div>
    </div>

    <div class="relay-control">
	<a href="/logs" class="fw-update-link">
          Страничка с logs
        </a>
      <h2>Управление реле</h2>
      
      
	  <div class="time-card">
        <h2>Управление насосом</h2>
		<!-- Добавляем кнопку автоматического режима -->
      <button id="automatBtn" class="automat-btn" onclick="toggleAutomat()">
        AUTO MODE (LOADING...)
      </button>
      </div>
	  

	  
      <div class="relay-buttons">
        <div class="time-card">
          <h2>Статус rele1</h2>
          <button id="relayBtn_1" class="btn-primary" onclick="toggleRelay_1()"> %RELE1_STATUS%</button>
        </div>
        
        <div class="time-card">
          <h2>Статус rele2</h2>
          <button id="relayBtn_2" class="btn-primary" onclick="toggleRelay_2()"> %RELE2_STATUS% </button>
        </div>

        <div class="time-card">
          <h2>Статус rele3</h2>
          <button id="relayBtn_3" class="btn-primary" onclick="toggleRelay_3()">%RELE3_STATUS%</button>
        </div>
        
        <div class="time-card">  
          <h2>Статус rele4</h2>
          <button id="relayBtn_4" class="btn-primary" onclick="toggleRelay_4()">%RELE4_STATUS%</button>
        </div>
      </div>
    </div>

    <div class="upload-section">
      <h1>Управление устройством</h1>
      
      <form>
        <label for="configFile">Обновить конфигурацию, загрузить config.json</label>
        <input type="file" id="configFile" name="configFile">
        <button type="button" class="btn-primary" onclick="uploadConfig()">
          📁 Загрузить Config
        </button>
      </form>

      <form>
        <label for="indexFile">Обновить интерфейс, загрузить index.html</label>
        <input type="file" id="indexFile" name="indexFile">
        <button type="button" class="btn-primary" onclick="uploadIndex()">
          📄 Загрузить Index
        </button>
      </form>
      
      <div class="firmware-section">
        <h2>Обновление прошивки</h2>
        <a href="/update" class="fw-update-link">
          ⚡ Обновить прошивку
        </a>
        <a href="/update_http" class="fw-update-link">
          ⚡ Обновить прошивку Update_http
        </a>
      </div>
    </div>

    <div id="message"></div>
    <div id="loading" class="loading">Идёт загрузка...</div>
  </div>
</body>
</html>